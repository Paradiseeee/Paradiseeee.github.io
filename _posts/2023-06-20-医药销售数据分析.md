---
layout:         post
title:          "医药销售数据分析"
subtitle:       "如何从日常数据中得到关键洞察"
date:           "2023-06-20 12:00:00"
author:         "Paradise"
header-img:     "post-assets/20230620/bg.jpg"
header-mask:    0.6
tags:
    - RCM
    - 市场分析
    - 数据分析
    - 数据可视化
---

## 一、数据源

来自某医药公司的产品销售数据，时间为 3 月到 5 月，共 48 个 Excel 表格。包含订单信息、售后信息、用户信息以及对应销售人员信息等。

<img src='/post-assets/20230620/source-data.png'>

加载合并后得到的原始数据如下：

<img src='/post-assets/20230620/summary.png'>

## 二、数据清洗

### **清洗流程以及对应细节**

> - **加载数据源**
>     - 表格形式没有统一，需要手动根据列名找到表头所在行
>     - 文件名包含日期信息，提取并加入到 DataFrame 新列
>     - 纵向拼接所有文件产生的 DataFrame
>     - 部分表格列名缺失，被加载到 `Unnamed: 0` 列，手动合并回对应列
> 
> - **数据清洗**
>     - 检查每列的唯一值和频数分布
>     - 删除含有无用信息的列和含有过多缺失、无效值的列
>     - 拆分下单日期和下单时间
> 
> - **信息脱敏**
>     - 将详细的收货地址映射为省份
>     - 员工名称用代号表示
>     - 商品名称用代号表示
>     - 输出员工名称和商品名称的映射字典以便回溯
>
> - **使用 pandas_profiling 输出汇总报告**

<details>
  <summary><b>展开查看数据预处理代码 ▼ ▼ ▼</b></summary>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-responsive"><table class="rouge-table table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre></td><td class="rouge-code"><pre><span class="c1"># 读取
</span><span class="k">def</span> <span class="nf">read_table</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="c1"># 表格形式没有统一，需要找到表头所在行
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="c1"># 部分表格列名不全，用两个字段确保匹配
</span>        <span class="k">if</span> <span class="s">'回访人'</span> <span class="ow">in</span> <span class="n">cols</span> <span class="ow">or</span> <span class="s">'订单编号'</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="c1"># 从文件名中提取日期，加入新列
</span>    <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r'(\d*?\.\d*?)日'</span><span class="p">,</span> <span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s">'0'</span> <span class="o">+</span> <span class="n">d</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'回访日期'</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s">'2023-0{m}-{d}'</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># 合并
</span><span class="k">def</span> <span class="nf">join_table</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="n">source_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">read_table</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">source_df</span> <span class="o">=</span> <span class="n">source_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">'index'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">'【读取成功】{f}'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">source_df</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s">'source_df'</span><span class="p">)</span>
<span class="n">source_df</span> <span class="o">=</span> <span class="n">join_table</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">())</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s">'../'</span><span class="p">)</span>

<span class="c1"># 部分表格没有回访人这个列名，被自动归到了新列，现在合并
</span><span class="n">source_df</span><span class="p">[</span><span class="s">'回访人'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">source_df</span><span class="p">[</span><span class="s">'Unnamed: 0'</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># 删除失效的列和含有空值的行
</span><span class="n">source_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">'Unnamed: 0'</span><span class="p">,</span> <span class="s">'Unnamed: 20'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">source_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'any'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># 删除含有隐私信息和无用信息的列
</span><span class="n">dumps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'客户姓名'</span><span class="p">,</span> <span class="s">'签收日期'</span><span class="p">,</span> <span class="s">'坐席人员'</span><span class="p">,</span> <span class="s">'订单编号'</span><span class="p">,</span> <span class="s">'发货编号'</span><span class="p">,</span> <span class="s">'快递编号'</span><span class="p">,</span> <span class="s">'商家备注'</span><span class="p">,</span> 
    <span class="s">'收货人号码'</span><span class="p">,</span> <span class="s">'来电号码'</span><span class="p">,</span> <span class="s">'购买用途'</span><span class="p">,</span> <span class="s">'客户微信'</span><span class="p">,</span> <span class="s">'店铺名称'</span><span class="p">,</span> <span class="s">'出生日期'</span><span class="p">,</span> <span class="s">'业务类型'</span>
    <span class="s">'是否为**用户'</span><span class="p">,</span> <span class="s">'是否添加微信'</span><span class="p">,</span> <span class="s">'销售状态'</span><span class="p">,</span> <span class="s">'收货人姓名'</span><span class="p">,</span> <span class="s">'来电日期'</span><span class="p">,</span> <span class="s">'客户情况备注'</span>
<span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">source_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dumps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 拆分下单日期
</span><span class="n">orderdate</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'下单日期'</span><span class="p">]</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">'下单日期'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">orderdate</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s">'下单时间'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">':'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">orderdate</span><span class="p">]</span>

<span class="c1"># 重新映射地址
</span><span class="k">def</span> <span class="nf">mapaddress</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
    <span class="n">provinces</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">'上海市'</span><span class="p">,</span> <span class="s">'广东省'</span><span class="p">,</span> <span class="s">'浙江省'</span><span class="p">,</span> <span class="s">'四川省'</span><span class="p">,</span> <span class="s">'河南省'</span><span class="p">,</span> <span class="s">'江苏省'</span><span class="p">,</span> <span class="s">'北京市'</span><span class="p">,</span> <span class="s">'湖北省'</span><span class="p">,</span> <span class="s">'海南省'</span><span class="p">,</span> 
        <span class="s">'广西壮族自治区'</span><span class="p">,</span> <span class="s">'山东省'</span><span class="p">,</span> <span class="s">'安徽省'</span><span class="p">,</span> <span class="s">'陕西省'</span><span class="p">,</span> <span class="s">'福建省'</span><span class="p">,</span> <span class="s">'甘肃省'</span><span class="p">,</span> <span class="s">'湖南省'</span><span class="p">,</span> <span class="s">'江西省'</span><span class="p">,</span> 
        <span class="s">'辽宁省'</span><span class="p">,</span> <span class="s">'云南省'</span><span class="p">,</span> <span class="s">'天津市'</span><span class="p">,</span> <span class="s">'重庆市'</span><span class="p">,</span> <span class="s">'山西省'</span><span class="p">,</span> <span class="s">'内蒙古自治区'</span><span class="p">,</span> <span class="s">'贵州省'</span><span class="p">,</span> <span class="s">'吉林省'</span><span class="p">,</span> 
        <span class="s">'黑龙江省'</span><span class="p">,</span> <span class="s">'宁夏回族自治区'</span><span class="p">,</span> <span class="s">'青海省'</span><span class="p">,</span> <span class="s">'河北省'</span><span class="p">,</span> <span class="s">'新疆维吾尔自治区'</span><span class="p">,</span> <span class="s">'西藏自治区'</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">province</span> <span class="ow">in</span> <span class="n">provinces</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">province</span> <span class="ow">in</span> <span class="n">address</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">province</span>

<span class="n">df</span><span class="p">[</span><span class="s">'客户地址'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mapaddress</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span> <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s">'客户地址'</span><span class="p">]]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s">'客户地址'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>

<span class="c1"># 信息脱敏
</span><span class="n">staffs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'回访人'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">staff_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">staffs</span><span class="p">,</span> <span class="p">[</span><span class="s">"staff_"</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">65</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">staffs</span><span class="p">))]))</span>
<span class="n">df</span><span class="p">[</span><span class="s">'回访人'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'回访人'</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">staff_mapping</span><span class="p">)</span>

<span class="n">products</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'商品名称'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">product_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">products</span><span class="p">,</span> <span class="p">[</span><span class="s">"product_"</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">65</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">products</span><span class="p">))]))</span>
<span class="n">df</span><span class="p">[</span><span class="s">'商品名称'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'商品名称'</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">product_mapping</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">'商品名称'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'商品名称'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s">'others[262]'</span><span class="p">)</span>   <span class="c1"># 另有 262 种不同商品或商品组合
</span>
<span class="c1"># 保存数据映射
</span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'staffs.json'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">staff_mapping</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'products.json'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">product_mapping</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

<span class="c1"># 数据概览
</span><span class="n">profile</span> <span class="o">=</span> <span class="n">ProfileReport</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">explorative</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">dark_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">profile</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="s">'dataset-report.html'</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'data.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>

</details>

### **数据概览报告**

<iframe src='/post-assets/20230620/dataset-report.html' width='100%' height='480px' frameborder='no'></iframe>


## 三、业务分析

### **提取数据中含有的信息提供对业务情况的洞察**：

> - 不同地区的销售情况对比，作为业务优化参考
> - 下单时间分布，揭示用户行为习惯
> - 单日订单量异常检测，追溯业务中可能存在的问题
> - 员工销售情况分析，提高销售效率
> - 来源渠道分布和 SKU 销量分布，及其关联分析

<details>
  <summary><b>展开查看可视化分析代码 ▼ ▼ ▼</b></summary>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-responsive"><table class="rouge-table table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
</pre></td><td class="rouge-code"><pre><span class="c1"># -*- coding: utf-8 -*- 
</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="n">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">Heaven</span> <span class="kn">import</span> <span class="n">mpl_tools</span>    <span class="c1"># https://github.com/paradiseeee/heaven
</span><span class="n">setting</span> <span class="o">=</span> <span class="n">mpl_tools</span><span class="o">.</span><span class="n">Begin</span><span class="p">()</span>
<span class="n">setting</span><span class="o">.</span><span class="n">set_font_family</span><span class="p">()</span>
<span class="n">setting</span><span class="o">.</span><span class="n">set_axis_unicode</span><span class="p">()</span>
<span class="n">setting</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s">'dark_background'</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">pyecharts</span>
<span class="kn">import</span> <span class="nn">pyecharts.charts</span> <span class="k">as</span> <span class="n">pyc</span>
<span class="kn">import</span> <span class="nn">pyecharts.options</span> <span class="k">as</span> <span class="n">opts</span>
<span class="kn">import</span> <span class="nn">pyecharts.globals</span> <span class="k">as</span> <span class="n">glbs</span>
<span class="kn">from</span> <span class="nn">pyecharts.commons.utils</span> <span class="kn">import</span> <span class="n">JsCode</span>

<span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">chart</span><span class="p">):</span>
    <span class="s">'''更改 js 引用源以提高加载速度'''</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">js_0</span><span class="o">=</span> <span class="s">'https://cdn.jsdelivr.net/npm/echarts@latest/dist/'</span>
    <span class="n">js_1</span> <span class="o">=</span> <span class="s">'https://assets.pyecharts.org/assets/'</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">js_0</span><span class="p">,</span> <span class="n">js_1</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">packing</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
    <span class="s">'''将序列打包为 pyecharts 接收的 data_pair'''</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span>
            <span class="n">series</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
            <span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">series</span><span class="p">],</span> 
                <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scale</span><span class="p">(</span><span class="n">series</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
    <span class="s">'''pd.series 转换维度归一化并转移为一维列表'''</span>
    <span class="n">arr_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">series</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">arr_T</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">arr_T</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># 数据预处理后生成的数据
</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'data.csv'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>

<span class="c1"># 一、地区销售情况对比
</span>
<span class="c1"># 省份列表
</span><span class="n">provinces</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'上海市'</span><span class="p">,</span> <span class="s">'广东省'</span><span class="p">,</span> <span class="s">'浙江省'</span><span class="p">,</span> <span class="s">'四川省'</span><span class="p">,</span> <span class="s">'河南省'</span><span class="p">,</span> <span class="s">'江苏省'</span><span class="p">,</span> <span class="s">'北京市'</span><span class="p">,</span> <span class="s">'湖北省'</span><span class="p">,</span> 
    <span class="s">'广西壮族自治区'</span><span class="p">,</span> <span class="s">'山东省'</span><span class="p">,</span> <span class="s">'安徽省'</span><span class="p">,</span> <span class="s">'陕西省'</span><span class="p">,</span> <span class="s">'福建省'</span><span class="p">,</span> <span class="s">'甘肃省'</span><span class="p">,</span> <span class="s">'湖南省'</span><span class="p">,</span> <span class="s">'江西省'</span><span class="p">,</span> 
    <span class="s">'辽宁省'</span><span class="p">,</span> <span class="s">'云南省'</span><span class="p">,</span> <span class="s">'天津市'</span><span class="p">,</span> <span class="s">'重庆市'</span><span class="p">,</span> <span class="s">'山西省'</span><span class="p">,</span> <span class="s">'内蒙古自治区'</span><span class="p">,</span> <span class="s">'贵州省'</span><span class="p">,</span> <span class="s">'吉林省'</span><span class="p">,</span> 
    <span class="s">'黑龙江省'</span><span class="p">,</span> <span class="s">'宁夏回族自治区'</span><span class="p">,</span> <span class="s">'青海省'</span><span class="p">,</span> <span class="s">'海南省'</span><span class="p">,</span> <span class="s">'河北省'</span><span class="p">,</span> <span class="s">'新疆维吾尔自治区'</span><span class="p">,</span> <span class="s">'西藏自治区'</span>
<span class="p">]</span>

<span class="c1"># 数据准备
</span><span class="n">orderNums</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'客户地址'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>   <span class="c1"># 地区订单量分布
</span><span class="n">totalSales</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'客户地址'</span><span class="p">)[</span><span class="s">'订单金额'</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>   <span class="c1"># 地区订单总金额分布
</span><span class="n">meanSales</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'客户地址'</span><span class="p">)[</span><span class="s">'订单金额'</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>   <span class="c1"># 地区订单均值分布
</span>
<span class="c1"># 绘图
</span><span class="nb">map</span> <span class="o">=</span> <span class="n">pyc</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span>
        <span class="n">init_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">InitOpts</span><span class="p">(</span><span class="n">theme</span><span class="o">=</span><span class="n">glbs</span><span class="o">.</span><span class="n">ThemeType</span><span class="o">.</span><span class="n">DARK</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s">'100</span><span class="si">%</span><span class="s">'</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s">'400px'</span><span class="p">,</span> <span class="n">bg_color</span><span class="o">=</span><span class="s">'#1a1c1d'</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">series_name</span><span class="o">=</span><span class="s">'总销售额'</span><span class="p">,</span>
        <span class="n">maptype</span><span class="o">=</span><span class="s">'china'</span><span class="p">,</span>
        <span class="n">is_map_symbol_show</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">zoom</span><span class="o">=</span><span class="mf">1.24</span><span class="p">,</span>
        <span class="n">data_pair</span><span class="o">=</span><span class="n">packing</span><span class="p">(</span><span class="n">totalSales</span><span class="p">),</span>
        <span class="n">emphasis_itemstyle_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">ItemStyleOpts</span><span class="p">(</span><span class="n">area_color</span><span class="o">=</span><span class="s">'#AABB33'</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">series_name</span><span class="o">=</span><span class="s">'订单数量'</span><span class="p">,</span>
        <span class="n">maptype</span><span class="o">=</span><span class="s">'china'</span><span class="p">,</span>
        <span class="n">is_map_symbol_show</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">zoom</span><span class="o">=</span><span class="mf">1.24</span><span class="p">,</span>
        <span class="n">data_pair</span><span class="o">=</span><span class="n">packing</span><span class="p">(</span><span class="n">orderNums</span><span class="p">),</span>
        <span class="n">emphasis_itemstyle_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">ItemStyleOpts</span><span class="p">(</span><span class="n">area_color</span><span class="o">=</span><span class="s">'#AABB33'</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">series_name</span><span class="o">=</span><span class="s">'均销售额'</span><span class="p">,</span>
        <span class="n">maptype</span><span class="o">=</span><span class="s">'china'</span><span class="p">,</span>
        <span class="n">is_map_symbol_show</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">zoom</span><span class="o">=</span><span class="mf">1.24</span><span class="p">,</span>
        <span class="n">data_pair</span><span class="o">=</span><span class="n">packing</span><span class="p">(</span><span class="n">meanSales</span><span class="p">),</span>
        <span class="n">emphasis_itemstyle_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">ItemStyleOpts</span><span class="p">(</span><span class="n">area_color</span><span class="o">=</span><span class="s">'#AABB33'</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">set_series_opts</span><span class="p">(</span>
        <span class="n">label_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">LabelOpts</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'#889099'</span><span class="p">,</span> <span class="n">is_show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">set_global_opts</span><span class="p">(</span>
        <span class="n">title_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">TitleOpts</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">"地区销售情况对比"</span><span class="p">),</span>
        <span class="n">legend_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">LegendOpts</span><span class="p">(</span>
            <span class="c1"># orient='vertical',
</span>            <span class="n">selected_mode</span><span class="o">=</span><span class="s">'single'</span><span class="p">,</span>
            <span class="n">pos_left</span><span class="o">=</span><span class="s">'2</span><span class="si">%</span><span class="s">'</span><span class="p">,</span> <span class="n">pos_bottom</span><span class="o">=</span><span class="s">'2.5</span><span class="si">%</span><span class="s">'</span><span class="p">,</span>
            <span class="n">item_gap</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">item_width</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">item_height</span><span class="o">=</span><span class="mi">16</span>
        <span class="p">),</span>
        <span class="n">visualmap_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">VisualMapOpts</span><span class="p">(</span>
            <span class="n">min_</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">range_color</span><span class="o">=</span><span class="p">[</span><span class="s">"#78A8F4"</span><span class="p">,</span> <span class="s">"#3F44A8"</span><span class="p">,</span> <span class="s">"#AD0083"</span><span class="p">],</span>
            <span class="n">range_text</span><span class="o">=</span><span class="p">[</span><span class="s">"100 </span><span class="si">%</span><span class="s">"</span><span class="p">,</span> <span class="s">"0 </span><span class="si">%</span><span class="s">"</span><span class="p">],</span>
            <span class="n">is_calculable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">orient</span><span class="o">=</span><span class="s">'horizontal'</span><span class="p">,</span> <span class="n">pos_left</span><span class="o">=</span><span class="s">'right'</span><span class="p">,</span> <span class="n">pos_top</span><span class="o">=</span><span class="s">'90</span><span class="si">%</span><span class="s">'</span><span class="p">,</span>
            <span class="n">item_width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">item_height</span><span class="o">=</span><span class="mi">100</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="c1"># 渲染
</span><span class="n">render</span><span class="p">(</span><span class="s">'地区销售情况对比.html'</span><span class="p">,</span> <span class="nb">map</span><span class="p">)</span>

<span class="c1"># 输出数据备份
</span><span class="n">sales</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s">'address'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">orderNums</span><span class="o">.</span><span class="n">index</span><span class="p">)})</span>
<span class="n">sales</span><span class="p">[</span><span class="s">'orderNums'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sales</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">orderNums</span><span class="p">))</span>
<span class="n">sales</span><span class="p">[</span><span class="s">'totalSales'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sales</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">totalSales</span><span class="p">))</span>
<span class="n">sales</span><span class="p">[</span><span class="s">'meanSales'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sales</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">meanSales</span><span class="p">))</span>
<span class="n">sales</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'sales-by-provinces.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="c1"># 二、下单时间分布饼状图
# 类似时钟的饼状图，宽度相等，通过颜色代表数值大小
</span><span class="n">clock</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">24</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">24</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'hour'</span><span class="p">,</span> <span class="s">'width'</span><span class="p">,</span> <span class="s">'value'</span><span class="p">])</span>
<span class="n">clock</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">clock</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'下单时间'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_pie</span><span class="p">(</span><span class="n">clock</span><span class="o">=</span><span class="n">clock</span><span class="p">,</span> <span class="n">meridiem</span><span class="o">=</span><span class="s">'AM/PM'</span><span class="p">):</span>

    <span class="n">clock</span> <span class="o">=</span> <span class="n">clock</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">meridiem</span> <span class="o">==</span> <span class="s">'AM'</span><span class="p">)</span> <span class="k">else</span> <span class="n">clock</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span>
    <span class="n">pie</span> <span class="o">=</span> <span class="n">pyc</span><span class="o">.</span><span class="n">Pie</span><span class="p">(</span>
        <span class="n">init_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">InitOpts</span><span class="p">(</span><span class="n">theme</span><span class="o">=</span><span class="n">glbs</span><span class="o">.</span><span class="n">ThemeType</span><span class="o">.</span><span class="n">DARK</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s">'100</span><span class="si">%</span><span class="s">'</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s">'360px'</span><span class="p">,</span> <span class="n">bg_color</span><span class="o">=</span><span class="s">'#1a1c1d'</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">series_name</span> <span class="o">=</span> <span class="s">'时间分布'</span><span class="p">,</span> 
        <span class="n">data_pair</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">clock</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clock</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">clock</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>
    <span class="p">)</span><span class="o">.</span><span class="n">set_series_opts</span><span class="p">(</span>
        <span class="n">label_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">LabelOpts</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="s">'inside'</span><span class="p">),</span> 
        <span class="n">tooltip_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">TooltipOpts</span><span class="p">(</span>
            <span class="n">formatter</span><span class="o">=</span><span class="n">JsCode</span><span class="p">(</span>   <span class="c1"># 默认工具提示显示宽度大小数值，需要手动设置
</span>                <span class="s">'''
                function (data) {
                    var start = data.name;
                    var end = parseInt(data.name) + 1;
                    var pop = parseInt(data.value[1]);
                    var line1 = start + ':00 ~ ' + end + ':00 ';
                    var line2 = '下单人数：' + pop;
                    return  line1 + '&lt;br/&gt;' + line2;
                }
                '''</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">set_global_opts</span><span class="p">(</span>
        <span class="n">title_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">TitleOpts</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">f</span><span class="s">'下单时间分布（{meridiem}）'</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># 根据分布数值大小映射颜色
</span>    <span class="n">colormapper</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">'YlOrRd'</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">clock</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">colorseq</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_hex</span><span class="p">(</span><span class="n">colormapper</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">clock</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
    <span class="n">pie</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">'color'</span><span class="p">]</span> <span class="o">=</span> <span class="n">colorseq</span>

    <span class="k">return</span> <span class="n">pie</span>

<span class="c1"># # 自带的 Page 对象很难调整，直接写个 html 嵌入（下单时间分布.html）
# page = pyc.Page(page_title='下单人数时间分布', layout=opts.PageLayoutOpts(display='inline', flex_wrap='nowrap'))
# page.add(plot_pie(meridiem='AM'), plot_pie(meridiem='PM'))
# page.render()
</span>
<span class="c1"># render('AM.html', plot_pie(meridiem='AM'))
# render('PM.html', plot_pie(meridiem='PM'))
</span><span class="n">plot_pie</span><span class="p">(</span><span class="n">meridiem</span><span class="o">=</span><span class="s">'AM'</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">'AM.html'</span><span class="p">)</span>
<span class="n">plot_pie</span><span class="p">(</span><span class="n">meridiem</span><span class="o">=</span><span class="s">'PM'</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">'PM.html'</span><span class="p">)</span>

<span class="c1"># 三、单日订单量异常检测
</span>
<span class="c1"># 移动窗口平均（周）
</span><span class="n">window</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">orderDates</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'下单日期'</span><span class="p">)[</span><span class="s">'下单日期'</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">orderDates</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">orderDates</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'2023-'</span><span class="p">,</span> <span class="s">''</span><span class="p">))</span>
<span class="n">orderDates_wr</span> <span class="o">=</span> <span class="n">orderDates</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">orderDates</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">window</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">orderDates</span> <span class="o">-</span> <span class="n">orderDates_wr</span>

<span class="n">orderDates</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">orderDates_wr</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">resid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">)</span>
<span class="c1"># plt.xticks(rotation=45)
</span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'单日订单量移动窗口平均 &amp; 两者残差'</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 残差频率密度分布
</span><span class="n">resid</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># 对应的正态分布的概率密度曲线
</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">resid</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'残差频率密度分布 &amp; 对应的正态分布'</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># QQ 图
</span><span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s">'norm'</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plt</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 四、销售人员业绩考核
</span><span class="k">def</span> <span class="nf">grouping</span><span class="p">(</span><span class="n">filed</span><span class="p">):</span>
    <span class="n">odnums</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">filed</span><span class="p">)[</span><span class="s">'订单金额'</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">msales</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">filed</span><span class="p">)[</span><span class="s">'订单金额'</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">tsales</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">filed</span><span class="p">)[</span><span class="s">'订单金额'</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">odnums</span><span class="p">,</span> <span class="n">msales</span><span class="p">,</span> <span class="n">tsales</span>

<span class="n">filed1</span> <span class="o">=</span> <span class="s">'回访人'</span>
<span class="n">grouping_1</span> <span class="o">=</span> <span class="n">grouping</span><span class="p">(</span><span class="n">filed1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">grouping_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">grouping_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'员工订单数量'</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">grouping_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">grouping_1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'员工总销售额'</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 五、各渠道销售聚合分析（类似地区）
</span><span class="n">filed2</span> <span class="o">=</span> <span class="s">'客户来源'</span>
<span class="n">grouping_2</span> <span class="o">=</span> <span class="n">grouping</span><span class="p">(</span><span class="n">filed2</span><span class="p">)</span>

<span class="c1"># 总销售额条形图
</span><span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">grouping_2</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">grouping_2</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'各客户来源总销售额'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 订单数量分布
</span><span class="n">sample</span> <span class="o">=</span> <span class="n">grouping_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'客户来源订单量分布'</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 六、SKU 聚合分析
</span><span class="n">filed3</span> <span class="o">=</span> <span class="s">'商品名称'</span>
<span class="n">grouping_3</span> <span class="o">=</span> <span class="n">grouping</span><span class="p">(</span><span class="n">filed3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">grouping_3</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">grouping_3</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'各 SKU 总销售额'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">sample</span> <span class="o">=</span> <span class="n">grouping_3</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'SKU 订单量分布'</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># 七、渠道-SKU 分析
</span><span class="n">df_pruned</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">'商品名称'</span><span class="p">]</span> <span class="o">!=</span> <span class="s">'others[262]'</span><span class="p">][</span><span class="n">df</span><span class="p">[</span><span class="s">'客户来源'</span><span class="p">]</span> <span class="o">!=</span> <span class="s">' '</span><span class="p">]</span>
<span class="n">source_top5</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="s">'FGHIJ'</span><span class="p">),</span> <span class="n">df_pruned</span><span class="p">[</span><span class="s">'客户来源'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

<span class="c1"># 交叉表
</span><span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="s">'ABCDE'</span><span class="p">):</span>
    <span class="k">exec</span><span class="p">(</span><span class="n">f</span><span class="s">"t{label} = df_pruned[df_pruned['商品名称'] == 'product_{label}']['客户来源'].value_counts().head(5)"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="s">'FGHIJ'</span><span class="p">):</span>
    <span class="k">exec</span><span class="p">(</span><span class="n">f</span><span class="s">"t{label} = df_pruned[df_pruned['客户来源'] == source_top5['{label}']]['商品名称'].value_counts().head(5)"</span><span class="p">)</span>

<span class="c1"># 子图布局
# axes = mpl_tools.Func().get_subplots('TTTTTTTTTT\nAABBCCDDEE\nAABBCCDDEE\nFFGGHHIIJJ\nFFGGHHIIJJ')
</span><span class="n">axes</span> <span class="o">=</span> <span class="n">mpl_tools</span><span class="o">.</span><span class="n">Func</span><span class="p">()</span><span class="o">.</span><span class="n">get_subplots</span><span class="p">(</span><span class="s">'ABCDE</span><span class="se">\n</span><span class="s">FGHIJ'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'商品各渠道来源分布 &amp; 渠道各商品销量分布'</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s">'left'</span><span class="p">)</span>
<span class="c1"># 子图与表一一对应
</span><span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="s">'ABCDEFGHIJ'</span><span class="p">):</span>
    <span class="k">exec</span><span class="p">(</span>
        <span class="n">f</span><span class="s">"axes['{label}'].pie(t{label}, labels=t{label}.index, "</span>
         <span class="o">+</span> <span class="s">"textprops={'fontsize':5}, radius=1.2)"</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="s">'ABCDE'</span><span class="p">:</span>
        <span class="k">exec</span><span class="p">(</span><span class="n">f</span><span class="s">"axes['{label}'].set_title('product_{label}')"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">exec</span><span class="p">(</span><span class="n">f</span><span class="s">"axes['{label}'].set_title(source_top5['{label}'])"</span><span class="p">)</span>

<span class="c1"># axes['T'].set_title('商品各渠道来源分布 &amp; 渠道各商品销量分布', loc='left')
</span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># 八、 staff vs sku、sources 切片分析
</span>
<span class="k">def</span> <span class="nf">plot_stack_bar</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">hue_index</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">pyc</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
        <span class="n">init_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">InitOpts</span><span class="p">(</span><span class="n">theme</span><span class="o">=</span><span class="n">glbs</span><span class="o">.</span><span class="n">ThemeType</span><span class="o">.</span><span class="n">DARK</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s">'100</span><span class="si">%</span><span class="s">'</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s">'360px'</span><span class="p">,</span> <span class="n">bg_color</span><span class="o">=</span><span class="s">'#1a1c1d'</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">add_xaxis</span><span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">hue_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">hue_index</span><span class="p">:</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">add_yaxis</span><span class="p">(</span>
            <span class="n">s</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]),</span>
            <span class="n">stack</span><span class="o">=</span><span class="s">'stack0'</span><span class="p">,</span> 
            <span class="n">bar_width</span><span class="o">=</span><span class="s">'60</span><span class="si">%</span><span class="s">'</span>
        <span class="p">)</span>
    <span class="n">bar</span><span class="o">.</span><span class="n">set_series_opts</span><span class="p">(</span>
            <span class="n">label_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">LabelOpts</span><span class="p">(</span><span class="n">is_show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">set_global_opts</span><span class="p">(</span>
            <span class="n">legend_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">LegendOpts</span><span class="p">(</span><span class="n">pos_left</span><span class="o">=</span><span class="s">'right'</span><span class="p">,</span> <span class="n">pos_top</span><span class="o">=</span><span class="s">'top'</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s">'vertical'</span><span class="p">),</span> 
            <span class="n">title_opts</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">TitleOpts</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">bar</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">'xAxis'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">'axisLabel'</span><span class="p">:</span> <span class="p">{</span><span class="s">'rotate'</span><span class="p">:</span> <span class="mi">90</span><span class="p">}})</span>
    <span class="k">return</span> <span class="n">bar</span>


<span class="n">title</span><span class="o">=</span><span class="s">'员工订单量 - 来源切片'</span>
<span class="n">hue_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_pruned</span><span class="p">[</span><span class="s">'客户来源'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">df_pruned</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'客户来源'</span><span class="p">,</span> <span class="s">'回访人'</span><span class="p">])[</span><span class="s">'订单金额'</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">bar</span> <span class="o">=</span> <span class="n">plot_stack_bar</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">hue_index</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">bar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">'员工vs客户来源.html'</span><span class="p">)</span>

<span class="n">title</span><span class="o">=</span><span class="s">'员工订单量 - SKU 切片'</span>
<span class="n">hue_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_pruned</span><span class="p">[</span><span class="s">'商品名称'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">df_pruned</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'商品名称'</span><span class="p">,</span> <span class="s">'回访人'</span><span class="p">])[</span><span class="s">'订单金额'</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">bar</span> <span class="o">=</span> <span class="n">plot_stack_bar</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">hue_index</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">bar</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">'员工vs商品名称.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>

</details>

### **（1）地区销售情况对比**

如图，包含总销售额、订单平均销售额和订单量三个维度的数据，点击图例可切换。其中总销售额和订单量最高的是江苏、山东、河南、辽宁几个省份，其次是河北、四川和广东。观察订单均价数据可以看到，对总销售额贡献较大的地区，订单均价都偏低。可以进一步分析的问题主要有：

- 当前商品售价是否处于最佳水平？偏离多少？
- 是否可以通过调整商品价格、开发的新的 SKU 以提高订单量和销售额？
- 相应地区的消费潜力是否充分挖掘？
- 是否可以策划营销活动、定向宣传，提高相应地区的销量？
- ...

另外注意到西藏自治区的订单均价偏高，是由于样本数量太小产生的误差，不作考虑。

<iframe src='/post-assets/20230620/地区销售情况对比.html' width='100%' height='420px' frameborder='no'></iframe>
<br/>

### **（2）用户下单行为分析**

如图，左右分别为 0-12 和 12-24 小时中的下单数量分布，可以直观地看到有较高的集中趋势。根据此行为习惯，可以在对应时段提高商品 pv，增加客服销售人员支持，促进用户下单和提高转化率，以提高销售业绩。

<iframe src='/post-assets/20230620/下单时间分布.html' width='100%' height='380px' frameborder='no'></iframe>
<br/>

### **（3）单日销量异常检测**

如图（上），为每日订单量折线图及其移动窗口平均，条形图为两者之差。通过平滑处理后可以看到整体呈平稳波动趋势。图（左下）为残差的频数密度分布，对比通过矩估计得到的总体正态分布（假设为正态总体）密度曲线。可以看到基本拟合正态分布，但存在异常值，图（右下）为 Q-Q 图，同样显示类似情况。

进一步分析残差条形图，发现每周末为一个谷值。04-05 ~ 04-09 出现一个异常的谷值，经查询时值清明假期。因此订单量的波动属于正常的节假日波动，业务水平呈总体平稳趋势。

<img src='/post-assets/20230620/单日订单量异常检测.jpg'>
<br/>

### **（4）员工销售情况分析**

如图，为不同员工的销售额和订单量，大体上处于一致的水平。其中 L、M、N 三个员工业绩明显偏低，经查询是由于在岗时间导致，并无异常。

<img src='/post-assets/20230620/不同员工的销售额和订单量.png'>
<br/>

进一步进行切片分析，如下图，可以看到每个员工不同渠道和不同产品的销量分布也大体一致。

<iframe src='/post-assets/20230620/员工订单量切片.html' width='100%' height='380px' frameborder='no'></iframe>
<br/>

### **（5）渠道与 SKU 关联分析**

如图为总样本不同渠道和不同 SKU 的销售额，趋势过于集中，容易因为某个渠道或某个产品的问题引起销售额较大的波动。因此适宜在巩固现有主力的前提下，开发和强化助力的渠道和产品。

<img src='/post-assets/20230620/不同渠道与不同商品的总销售额.png'>
<br/>

进一步分析，下图分别为总样本的订单量分布和对两个维度切片的订单量分布（取前五名类别进行切片）。通过两个维度切片进行关联分析，可以看到**产品C与客服转接渠道**、**产品E与百度信息流渠道**有明显对应关系（不同于总样本和其他切片）。因此可以进一步研究其特点，结合地区销售情况，用户行为习惯等分析，推出营销活动，作为提高销售业绩的突破口。

<img src='/post-assets/20230620/不同渠道与不同商品的订单量.png'>
<br/>
<img src='/post-assets/20230620/SKU-渠道分析.png'>


## 四、使用 Quick BI 创建可视化仪表板

最后探索性地使用一下阿里云提供的 Quick BI，与 PowerBI、Tableau 等工具类似，通过面板进行拖拽选项设置等操作，无代码完成可视化过程。对于常规的可视化图形，可以快速实现，并且风格自适应，省去很多调整操作。但是对于复杂的高度定制化的图表，操作难度过大，文档也不够完备便捷，还是代码工具更加好用。以下为简单的示例：

<img src='/post-assets/20230620/quick-bi-example.png'>

<a href='https://bi.aliyuncs.com/token3rd/dashboard/view/pc.htm?pageId=ed9b43ac-113a-4bb6-aafc-a1177160d802&accessToken=2b4ed03f49e855070c7c06c624ec680e&dd_orientation=auto' target='_blank'>> 查看交互式网页</a>

-------------------------------------
END


